name: Deploy to Proxmox Docker VM

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  APP_DIR: /opt/card-game-engine

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: [self-hosted, linux, proxmox]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync source to app directory
        run: |
          rsync -a --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            "${{ github.workspace }}/" "${{ env.APP_DIR }}/"

      - name: Build and deploy with Docker Compose
        working-directory: ${{ env.APP_DIR }}
        run: |
          set -e

          echo "=== Building Docker images ==="
          docker compose build

          echo "=== Deploying containers ==="
          docker compose down --remove-orphans || true
          docker compose up -d

          echo "=== Waiting for services to start ==="
          sleep 10

          echo "=== Health check: backend ==="
          for i in $(seq 1 12); do
            if docker compose exec -T backend wget --no-verbose --tries=1 --spider http://127.0.0.1:3001/api/health 2>/dev/null; then
              echo "Backend is healthy!"
              break
            fi
            if [ "$i" -eq 12 ]; then
              echo "Backend health check failed!"
              docker compose logs backend
              exit 1
            fi
            echo "Attempt $i: Backend not ready yet, waiting..."
            sleep 5
          done

          echo "=== Health check: frontend ==="
          for i in $(seq 1 12); do
            if docker compose exec -T frontend wget --no-verbose --tries=1 --spider http://127.0.0.1:80/ 2>/dev/null; then
              echo "Frontend is healthy!"
              break
            fi
            if [ "$i" -eq 12 ]; then
              echo "Frontend health check failed!"
              docker compose logs frontend
              exit 1
            fi
            echo "Attempt $i: Frontend not ready yet, waiting..."
            sleep 5
          done

          echo "=== Pruning old Docker images ==="
          docker image prune -f

          echo "=== Deployment complete ==="
          docker compose ps

      - name: Deployment summary
        run: |
          echo "### Deployment to Proxmox Docker VM" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner:** $(hostname)" >> $GITHUB_STEP_SUMMARY
          echo "- **App URL:** https://gaming.benjathi.de" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Deployed successfully" >> $GITHUB_STEP_SUMMARY
